<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{_layouts/layout}">
<head>


    <meta charset="UTF-8">
    <title>products by type</title>
</head>
<body>


<div layout:fragment="content">
    <div class="container">
        <div class="row">
            <div th:utext="${errMessage}"></div>


            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4">
                <div class="col mb-4 px-2 card__block" th:each="product:${productList}">

                    <div class="card card__item h-100 click" th:href="@{'/cart/item/'+ ${product.id}}">
                        <i class="fa-regular fa-heart"></i>
                        <div class="card__badge">
                            <div class="card__sale__badge">
                                <a href="#"><i class="fa-solid fa-tag px-2"></i> -23%</a>
                            </div>
                            <div class="card__new__badge">
                                <a href="#"><i class="fa-solid fa-bolt px-2"></i>latest</a>
                            </div>
                            <div class="card__akcia__badge">
                                <a href="#"><i class="fa-solid fa-stopwatch px-2"></i>promotion</a>
                            </div>
                        </div>
                        <div class="card__top">
                            <img src="" th:src="@{/{filename}(filename=${product.getPicture().getSmPictureName()})}"
                                 class="card-img-top mx-auto my-2 px-2" alt="...">
                        </div>
                        <div class="card-body">
                            <h6 class="card-title" th:utext="${product.getProductName()}">Elak 500 gram</h6>
                            <p class="card__contents ">This is a longer card with supporting text below as a
                                natural </p>
                            <div>
                                <h5 class="card__prise" th:utext="${product.getStock().getPurchasePrice()}">5000<span
                                        class="card__contents">AMD</span></h5>
                                <h6 class="card__prise  pl-3">
                                    <del class="text-muted">5000</del>
                                    <span class="card__contents aaaaa">AMD</span>
                                </h6>
                            </div>
                            <p class="card__contents"> art N 0152625</p>
                            <p class="card__contents mb-1"><i class="fa-solid fa-truck"></i> Tomorrow</p>
                            <div class="card__contents ">
                                <form id="myForm" method="post" th:action="@{/cart}" th:object="${cartItem}">

                                    <input type="hidden" class="form-control" id="productId"
                                           th:value="${product.getId()}" name="productId">
                                    <input type="hidden" class="form-control" id="prodQuantity" th:value="1"
                                           name="quantity">
                                    <!--                                    <div class="cart__spinner form-group">-->
                                    <!--                                        <input th:value="${session.cart.getCartItems()[__${product.getId()}__].getQuantity()}"-->
                                    <!--                                               name="quantity" min="0" max="100" type="hidden" class="form-control"-->
                                    <!--                                               id="quantity" autocomplete="off"/>-->
                                    <!--                                    </div>-->
                                    <div class="card__shopping__cart">
                                        <button type="button" class="add__product"><i class="fas fa-shopping-cart"></i>
                                        </button>
                                    </div>
                                </form>
                                <!--                                <a href="#" th:href="@{'/cart/add/'+'product?id='+${product.getId()} + '&quantity=1'}"><i class="fas fa-shopping-cart"></i>-->
                                <!--                                </a>-->
                            </div>

<!--                            <div>-->
<!--                                <form method="post">-->
<!--                                    <div class="cart__spinner form-group">-->
<!--                                        <label for="quantity">Quantity</label>-->
<!--                                        <input value="0" min="0" max="100" type="number" class="form-control"-->
<!--                                               id="quantity"-->
<!--                                               autocomplete="off"/>-->
<!--                                    </div>-->
<!--                                </form>-->
<!--                            </div>-->

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<div layout:fragment="scripts">
    <script th:src="@{/js/bootstrap-input-spinner.js}"></script>

    <script type="text/javascript">
        var $input = $("input[type='number']");
        $input.inputSpinner({
            decrementButton: "<i class=\"cart__spinner_btn fa-solid fa-circle-minus \"></i>", // button text
            incrementButton: "<i class=\"cart__spinner_btn fa-solid fa-circle-plus \"></i>", // ..
            groupClass: 'input', // css class of the resulting input-group
            buttonsClass: "",
            buttonsOnly: true
        })



        $('button.add__product').click(function () {
            var $this = $(this);
            var form = $this.parents('form:first');
            var url = form.attr('action');
            var jsonData = JSON.stringify(form.serializeObject());
            $.ajax({
                type: "post",
                url: url,
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: jsonData,
                success: function (data) {
                    var totalItems = data["itemsNumber"];
                    // $this.after('<a href="' + url + '" class="btn btn-warning">в корзине</a>');
                    // $this.remove();
                    // var quantity = $("input#prodQuantity").val();
                    // if (quantity > 0) {
                    //     $this.hide();
                    // }
                    // alert(quantity);

                    $('#cart-total-items').empty().html('<span class="badge badge-warning ">' + totalItems + '</span>');
                    console.log(totalItems);
                },
                error: function () {
                    alert("Что-то пошло не так.\nПопробуйте добавить товар ещё раз.");
                }
            });
        });
        $.fn.serializeObject = function () {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function () {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };


        //
        // $(function (){
        //     $('.card__shopping__cart').click(function (){
        //        $(this).hide();
        //         var $form = {};
        //         $('#myForm').find ('input, textearea, select').each(function() {
        //             $form[this.name] = $(this).val();
        //         });
        //         // var $aaa = $.param($form);
        //         var $aaa = decodeURIComponent($.param($form));
        //         // var $aaa = text($.param($form));
        //
        //         // $('.card__shopping__cart').text($.param($data));
        //         $.ajax({
        //             url:"/cart/add/product?"+$aaa,
        //             success:function (result) {
        //                 console.log(result.id)
        //                 // $('.aaaa').text(result.productName)
        //
        //             },
        //             cache : false,
        //
        //         });
        //     });
        //
        // });
        // $(function (){
        //     $('.but').click(function (){
        //
        //         // $.ajax('/show/get/products',function (result, status){
        //         //     console.log(result.productName);
        //         // })
        //
        //         $.ajax({
        //                 url:"/get/products",
        //             success:function (result){
        //                     console.log(result.id);
        //                 $('.aaaaa').text(result.productName);
        //             }
        //         })
        //     })
        // })


    </script>
</div>
</body>
</html>